<?xml version="1.0" encoding="UTF-8"?>
<!-- http://sdformat.org/tutorials?tut=spec_world&cat=specification& -->


<!-- MARK: - Primary Variables -->

<%
  shelfWidth = 1.1 # [m]
  shelfLength = 3.3 # [m]
  shelfHeight = 12.5 # [m]
  spaceBetweenShelves = 0.3 # [m]
  columnInfos = [
    {'space' => 3.6, 'doesContainShelf' => false},
    {'space' => shelfWidth, 'doesContainShelf' => true},
    {'space' => spaceBetweenShelves, 'doesContainShelf' => false},
    {'space' => shelfWidth, 'doesContainShelf' => true},
    {'space' => 3.1, 'doesContainShelf' => false},
    {'space' => shelfWidth, 'doesContainShelf' => true},
    {'space' => spaceBetweenShelves, 'doesContainShelf' => false},
    {'space' => shelfWidth, 'doesContainShelf' => true},
    {'space' => 3.1, 'doesContainShelf' => false},
    {'space' => shelfWidth, 'doesContainShelf' => true},
    {'space' => spaceBetweenShelves, 'doesContainShelf' => false},
    {'space' => shelfWidth, 'doesContainShelf' => true},
    {'space' => 3.1, 'doesContainShelf' => false},
    {'space' => shelfWidth, 'doesContainShelf' => true},
    {'space' => spaceBetweenShelves, 'doesContainShelf' => false},
    {'space' => shelfWidth, 'doesContainShelf' => true},
    {'space' => 3.1, 'doesContainShelf' => false},
    {'space' => shelfWidth, 'doesContainShelf' => true},
    {'space' => spaceBetweenShelves, 'doesContainShelf' => false},
    {'space' => shelfWidth, 'doesContainShelf' => true},
    {'space' => 3.1, 'doesContainShelf' => false},
    {'space' => shelfWidth, 'doesContainShelf' => true},
    {'space' => 0.818, 'doesContainShelf' => false}
  ]
  rowInfos = [
    {'space' => 1.0, 'isShelf' => false},
    {'space' => shelfLength, 'isShelf' => true},
    {'space' => shelfLength, 'isShelf' => false},
    {'space' => shelfLength, 'isShelf' => true},
    {'space' => shelfLength, 'isShelf' => true},
    {'space' => shelfLength, 'isShelf' => true},
    {'space' => shelfLength, 'isShelf' => true},
    {'space' => shelfLength, 'isShelf' => true},
    {'space' => shelfLength, 'isShelf' => true},
    {'space' => shelfLength, 'isShelf' => false},
    {'space' => shelfLength, 'isShelf' => true},
    {'space' => shelfLength, 'isShelf' => true},
    {'space' => shelfLength, 'isShelf' => true},
    {'space' => shelfLength, 'isShelf' => true},
    {'space' => shelfLength, 'isShelf' => true},
    {'space' => shelfLength, 'isShelf' => true},
    {'space' => shelfLength, 'isShelf' => false},
    {'space' => shelfLength, 'isShelf' => true},
    {'space' => 1.0, 'isShelf' => false}
  ]

  # lights
  lightAmountAlongLengthAxis = 6
  lightAmountAlongWidthAxis = 6
  lightHeight = shelfHeight*1.5
  ceilingLightInnerAngle = Math::PI/6
  ceilingLightOuterAngle = Math::PI*5/6
%>


<!-- MARK: - Secondary Variables -->
<%
  halfShelfHeight = shelfHeight/2.0
  halfShelfLength = shelfLength/2.0
  halfShelfWidth = shelfWidth/2.0
  initialYawAngle = Math::PI/2.0

  # room spec
  roomLength = columnInfos.map{ |columnInfo| columnInfo['space'] }.sum
  roomWidth = rowInfos.map{ |rowInfo| rowInfo['space'] }.sum

  # lights
  lightInfos = []
  spaceBetweenLightsAlongLengthAxis = roomLength / (lightAmountAlongLengthAxis+1)
  spaceBetweenLightsAlongWidthAxis = roomWidth / (lightAmountAlongWidthAxis+1)
  counterX = 0
  counterY = 0
  spaceBetweenLightsAlongLengthAxis.step(roomLength - 1e-6, spaceBetweenLightsAlongLengthAxis) do |x|
    spaceBetweenLightsAlongWidthAxis.step(roomWidth - 1e-6, spaceBetweenLightsAlongWidthAxis) do |y|
      lightInfos.push({
        'name' => "ceilingLight_#{counterX}_#{counterY}",
        'position' => [x, y, lightHeight]
      })
      counterY += 1
    end
    counterX += 1
  end
%>


<!-- MARK: - Dummy Variables -->

<%
  cursorX = 0.0
  cursorY = 0.0
  columnIndex = 0
  rowIndex = 0
%>

<!-- MARK: - Main -->

<sdf version='1.6'>
<world name="warehouse">

  <!-- define camera -->
  <gui>
    <camera name='user_camera'>
      <pose>20 5 50 0 -0.5 0</pose>
    </camera>
  </gui>

  <!-- define physic engine -->
  <!-- <physics name="physics" type="ode" default=true>
    <max_step_size>0.1</max_step_size>
    <real_time_factor>1</real_time_factor>
    <real_time_update_rate>100</real_time_update_rate>
    <max_contacts>5</max_contacts>
    <ode>
      <solver>
        <island_threads>4</island_threads>
        <iters>10</iters>
      </solver>
    </ode>
  </physics> -->


  <!-- define scenes and lights -->
  <scene>
    <ambient>0.2 0.2 0.2 0</ambient>
    <shadow>true</shadow>
  </scene>

  <!--
  <% for lightInfo in lightInfos %>
    <% lightPosition = lightInfo['position'] %>
    <light name="<%=lightInfo['name']%>" type="spot">
      <pose><%=lightPosition[0]%> <%=lightPosition[1]%> <%=lightPosition[2]%> 0 0 0</pose>
      <direction>0 0 -1</direction>
      <cast_shadows>true</cast_shadows>

      <diffuse>1 1 1 1</diffuse>

      <attenuation>
        <range>100</range>
        <constant>0.9</constant>
        <linear>0.1</linear>
      </attenuation>

      <spot>
        <inner_angle><%=ceilingLightInnerAngle%></inner_angle>
        <outer_angle><%=ceilingLightOuterAngle%></outer_angle>
        <falloff>1.0</falloff>
      </spot>
    </light>
  <% end %>
  -->


  <!-- include ground plane -->
  <include>
    <uri>model://ground_plane</uri>
  </include>

  <include>
    <uri>model://sun</uri>
    <pose>0 0 50</pose>
  </include>


  <!-- include all the shelves -->
  <% for columnInfo in columnInfos %>
    <% if (columnInfo['doesContainShelf'] == true) %>
      <!-- reset cursorY position and rowIndex -->
      <%
        cursorY = 0.0
        rowIndex = 0
      %>
      <!-- loop for all rows -->
      <% for rowInfo in rowInfos %>
        <!-- if the position is shelf, spawn a shelf -->
        <% if (rowInfo['isShelf'] == true) %>
          <include>
            <uri>shelf</uri>
            <name><%="shelf_row#{rowIndex}_column#{columnIndex}"%></name>
            <pose><%=cursorX+halfShelfWidth%> <%=cursorY+halfShelfLength%> 0 0 0 <%=initialYawAngle%></pose>
          </include>
        <% end %>
        <!-- prepare for next row -->
        <%
          cursorY += rowInfo['space']
          rowIndex += 1
        %>
      <% end %>
    <% end %>
    <!-- prepare for next column -->
    <%
      cursorX += columnInfo['space']
      columnIndex += 1
    %>
  <% end %>


  <!-- include walls -->
  <include>
    <uri>walls</uri>
    <pose>0 0 0 0 0 0</pose>
  </include>


  <actor name="free_person">
    <pose>10 10 0 0 0 0</pose>
    <skin>
      <filename>walk.dae</filename>
      <scale>1.0</scale>
    </skin>
    <animation name="walking">
      <filename>walk.dae</filename>
      <scale>1.0</scale>
      <interpolate_x>true</interpolate_x>
    </animation>
    <plugin name="free_person_plugin" filename="libActorPlugin.so">
      <target>3 2 1.24</target>
      <target_weight>1.15</target_weight>
      <obstacle_weight>1.8</obstacle_weight>
      <ignore_obstacles>
        <model>walls</model>
        <model>ground_plane</model>
      </ignore_obstacles>
    </plugin>
  </actor>

</world>
</sdf>
