<?xml version="1.0" encoding="UTF-8"?>
<!-- http://sdformat.org/tutorials?tut=spec_world&cat=specification& -->


<!-- MARK: - Primary Variables -->

<%
  shelfWidth = 1.1 # [m]
  shelfLength = 3.3 # [m]
  shelfHeight = 12.5 # [m]
  spaceBetweenShelves = 0.3 # [m]
  columnInfos = [
    {'space' => 3.6, 'doesContainShelf' => false},
    {'space' => shelfWidth, 'doesContainShelf' => true},
    {'space' => spaceBetweenShelves, 'doesContainShelf' => false},
    {'space' => shelfWidth, 'doesContainShelf' => true},
    {'space' => 3.1, 'doesContainShelf' => false},
    {'space' => shelfWidth, 'doesContainShelf' => true},
    {'space' => spaceBetweenShelves, 'doesContainShelf' => false},
    {'space' => shelfWidth, 'doesContainShelf' => true},
    {'space' => 3.1, 'doesContainShelf' => false},
    {'space' => shelfWidth, 'doesContainShelf' => true},
    {'space' => spaceBetweenShelves, 'doesContainShelf' => false},
    {'space' => shelfWidth, 'doesContainShelf' => true},
    {'space' => 3.1, 'doesContainShelf' => false},
    {'space' => shelfWidth, 'doesContainShelf' => true},
    {'space' => spaceBetweenShelves, 'doesContainShelf' => false},
    {'space' => shelfWidth, 'doesContainShelf' => true},
    {'space' => 3.1, 'doesContainShelf' => false},
    {'space' => shelfWidth, 'doesContainShelf' => true},
    {'space' => spaceBetweenShelves, 'doesContainShelf' => false},
    {'space' => shelfWidth, 'doesContainShelf' => true},
    {'space' => 3.1, 'doesContainShelf' => false},
    {'space' => shelfWidth, 'doesContainShelf' => true},
    {'space' => 0.818, 'doesContainShelf' => false}
  ]
  rowInfos = [
    {'space' => 1.0, 'isShelf' => false},
    {'space' => shelfLength, 'isShelf' => true},
    {'space' => shelfLength, 'isShelf' => false},
    {'space' => shelfLength, 'isShelf' => true},
    {'space' => shelfLength, 'isShelf' => true},
    {'space' => shelfLength, 'isShelf' => true},
    {'space' => shelfLength, 'isShelf' => true},
    {'space' => shelfLength, 'isShelf' => true},
    {'space' => shelfLength, 'isShelf' => true},
    {'space' => shelfLength, 'isShelf' => false},
    {'space' => shelfLength, 'isShelf' => true},
    {'space' => shelfLength, 'isShelf' => true},
    {'space' => shelfLength, 'isShelf' => true},
    {'space' => shelfLength, 'isShelf' => true},
    {'space' => shelfLength, 'isShelf' => true},
    {'space' => shelfLength, 'isShelf' => true},
    {'space' => shelfLength, 'isShelf' => false},
    {'space' => shelfLength, 'isShelf' => true},
    {'space' => 1.0, 'isShelf' => false}
  ]

  # lights
  lightAmountAlongLengthAxis = 5
  lightAmountAlongWidthAxis = 5
  lightHeight = shelfHeight*1.5
%>


<!-- MARK: - Secondary Variables -->
<%
  halfShelfHeight = shelfHeight/2.0
  halfShelfLength = shelfLength/2.0
  halfShelfWidth = shelfWidth/2.0
  initialYawAngle = Math::PI/2.0

  # room spec
  roomLength = columnInfos.map{ |columnInfo| columnInfo['space'] }.sum
  roomWidth = rowInfos.map{ |rowInfo| rowInfo['space'] }.sum

  # lights
  lightInfos = []
  spaceBetweenLightsAlongLengthAxis = roomLength / (lightAmountAlongLengthAxis+1)
  spaceBetweenLightsAlongWidthAxis = roomWidth / (lightAmountAlongWidthAxis+1)
  counterX = 0
  counterY = 0
  0.0.step(roomLength - 1e-6, spaceBetweenLightsAlongLengthAxis) do |x|
    0.0.step(roomWidth - 1e-6, spaceBetweenLightsAlongWidthAxis) do |y|
      lightInfos.push({
        'name' => "ceilingLight_#{counterX}_#{counterY}",
        'position' => [x, y, lightHeight, 0]
      })
      counterY += 1
    end
    counterX += 1
  end
%>


<!-- MARK: - Dummy Variables -->

<%
  cursorX = 0.0
  cursorY = 0.0
  columnIndex = 0
  rowIndex = 0
%>

<!-- MARK: - Main -->

<sdf version='1.6'>
<world name="warehouse">
  <!-- Define scenes and lights -->
  <scene>
    <ambient>0 0 0 0</ambient>
    <shadow>true</shadow>
  </scene>
  <% for lightInfo in lightInfos %>
    <% lightPosition = lightInfo['position'] %>
    <light name="<%=lightInfo['name']%>" type="spot">
      <pose><%=lightPosition[0]%> <%=lightPosition[1]%> <%=lightPosition[2]%> <%=lightPosition[3]%></pose>
      <direction>0 0 -1</direction>
      <cast_shadows>true</cast_shadows>
      <diffuse>1 1 1 1</diffuse>
      <attenuation>
        <range>1000</range>
        <linear>1.0</linear>
      </attenuation>
    </light>
  <% end %>


  <% for columnInfo in columnInfos %>
    <% if (columnInfo['doesContainShelf'] == true) %>
      <!-- reset cursorY position and rowIndex -->
      <%
        cursorY = 0.0
        rowIndex = 0
      %>
      <!-- loop for all rows -->
      <% for rowInfo in rowInfos %>
        <!-- if the position is shelf, spawn a shelf -->
        <% if (rowInfo['isShelf'] == true) %>
          <include>
            <uri>shelf</uri>
            <name><%="shelf_row#{rowIndex}_column#{columnIndex}"%></name>
            <pose><%=cursorX+halfShelfWidth%> <%=cursorY+halfShelfLength%> 0 0 0 <%=initialYawAngle%></pose>
          </include>
        <% end %>
        <!-- prepare for next row -->
        <%
          cursorY += rowInfo['space']
          rowIndex += 1
        %>
      <% end %>
    <% end %>
    <!-- prepare for next column -->
    <%
      cursorX += columnInfo['space']
      columnIndex += 1
    %>
  <% end %>

</world>
</sdf>
